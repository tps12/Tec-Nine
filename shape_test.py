from unittest import TestCase, main

from numpy import array

from shape import *

class ShapeTestCase(TestCase):
    def test_merge_creating_self_intersection(self):
        """When other is un- and then reprojected into shape's coordinate system
        it ends up self-intersecting, even though the original shape is valid.

        Instead of throwing an exception, merge should remove the self-intersection
        and allow the merge to take place."""

        shape = Shape([(-0.3507905005301932, -0.5421600206217014), (-0.9598660494040884, -0.6535343963327993), (-1.1460102484894485, -0.45514586374764826), (-1.1393964384683963, -0.004536585345849927), (-0.7267411004372454, -0.0037706475180107023), (-0.6880296743729558, -0.04544597288906214), (0.00870203392443035, -0.05337788852251905), (0.30350464516140263, -0.560201780756317), (0.5881185055419087, -0.3766179307120662), (0.9614015992623804, -0.5140108797761249), (1.2994776532474148, -0.3154353884936491), (1.6026438420134073, -0.3434002124876674), (1.3206809603756582, 0.1530005247663384), (1.327495839218039, 0.17047293328826368), (1.3697149555463466, 0.1367305549082816), (1.3937726813590245, 0.20146072956098746), (1.4133273411557827, 0.1745197272007255), (1.4438957704645914, 0.3582531619318458), (1.4608781215853892, 0.5695523215113661), (1.7075114541401564, -0.6388995991579737), (1.5179749658726143, -0.9416553833898281), (0.5924611845409792, -1.1176396736862626), (0.5410686225032426, -1.0244746074452016), (0.4273259214955646, -1.1299858682406596), (0.1714780797078178, -1.1734770463400241), (-0.32041158149923427, -0.587221478748846), (-0.3333239222182373, -0.5893287320557864), (-0.30064476699054793, -0.48974381968336006), (-0.32602881381777327, -0.4617286815474739), (-0.3507905005301932, -0.5421600206217014)],
            array([ 0.47196342,  0.87803432, -0.079412  ]),
            array([ 0.86821231, -0.44724901,  0.21488532]),
            array([ 94.64710625,  16.30650768,  13.48742552]))

        other = Shape([(1.1162517044337512, 1.305400697477363), (1.1295082245364534, 1.3046694122751494), (1.0855340075273234, 0.8923295646490244), (1.1858073468553734, 1.0235893162655345), (1.3986521024232395, 0.9554552318681849), (1.4528148496899072, 1.0412560264221744), (1.6281581837016612, 1.248317841285991), (1.6585352929839257, 0.8722635967636574), (1.664154284721875, 0.8704648920867203), (1.9056146300167427, 0.6970910598011348), (1.685763305459625, 0.5351936811817972), (1.7666522475404092, -0.46617316125702113), (1.4300988793728695, 0.008427468671670602), (1.4449409546284233, -0.5857584302890387), (1.4233026675810008, -0.6015530361634429), (1.254539027329498, -0.3694940212414316), (1.0687637145484328, 0.7541800823544356), (0.9968182913540206, 0.21602711565491195), (1.0810587214891956, 0.017255047324567698), (0.5870581852520067, 0.12402547507569013), (-0.09487745180480377, -0.4708068293878157), (-0.10973883829573787, -0.4169568749429632), (0.8924744378071343, 0.4191270193209444), (0.8567384231206852, 0.607719872952876), (0.8808950830117971, 0.4523693406212562), (-0.13118509763669584, -0.3624866899765351), (-0.1573632174356852, -0.26862645724769746), (-0.20805628645477953, 0.13806087254728316), (-0.20964929127839832, 0.15376832214574304), (0.07552052282451548, 0.21822860440445166), (0.799007730990157, 0.39635091023993724), (0.8007135493562056, 0.4077783784964876), (0.8017224231114152, 0.4080778111352513), (0.7630588433995509, 0.6220666310110357), (0.7503849460290646, 0.6154683512551445), (1.1162517044337512, 1.305400697477363)],
            array([-0.05402659,  0.97370704, -0.2213046 ]),
            array([ 0.98803676,  0.02006887, -0.15290714]),
            array([ -9.93713318, -11.3481565 , -94.8087977 ]))

        shape.merge(other)
                             
if __name__ == '__main__':
    main()
